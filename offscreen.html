<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Token Fetcher</title>
</head>
<body>
    <div id="status">Initializing...</div>
    
    <script>
        console.log('üé¨ Offscreen document loaded');
        
        // L·∫Øng nghe tin nh·∫Øn t·ª´ popup
        chrome.runtime.onMessage.addListener((message, sender, sendResponse) => {
            if (message.action === 'fetchTokenOffscreen') {
                console.log('üì® Nh·∫≠n y√™u c·∫ßu fetch token');
                fetchTokenViaIframe(message.targetUrl || 'https://business.facebook.com/')
                    .then(result => {
                        console.log('‚úÖ Fetch complete:', result.success);
                        sendResponse(result);
                    })
                    .catch(error => {
                        console.error('‚ùå Fetch error:', error);
                        sendResponse({
                            success: false,
                            error: error.message
                        });
                    });
                return true;
            }
        });
        
        async function fetchTokenViaIframe(targetUrl) {
            return new Promise((resolve, reject) => {
                try {
                    console.log('üîç T·∫°o iframe ƒë·ªÉ fetch:', targetUrl);
                    
                    // T·∫°o iframe ·∫©n
                    const iframe = document.createElement('iframe');
                    iframe.style.display = 'none';
                    iframe.style.width = '0px';
                    iframe.style.height = '0px';
                    
                    let resolved = false;
                    const timeout = setTimeout(() => {
                        if (!resolved) {
                            resolved = true;
                            document.body.removeChild(iframe);
                            reject(new Error('Timeout sau 15 gi√¢y'));
                        }
                    }, 15000);
                    
                    iframe.onload = () => {
                        try {
                            if (resolved) return;
                            
                            console.log('üìÑ Iframe loaded, ƒëang extract token...');
                            
                            // Truy c·∫≠p document c·ªßa iframe
                            const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                            const html = iframeDoc.documentElement.outerHTML;
                            
                            console.log('üìù HTML size:', html.length);
                            
                            // Extract token
                            const token = extractTokenFromHTML(html);
                            
                            resolved = true;
                            clearTimeout(timeout);
                            document.body.removeChild(iframe);
                            
                            if (token) {
                                resolve({
                                    success: true,
                                    token: token,
                                    source: targetUrl,
                                    timestamp: new Date().toISOString(),
                                    method: 'iframe'
                                });
                            } else {
                                resolve({
                                    success: false,
                                    error: 'Kh√¥ng t√¨m th·∫•y token trong trang',
                                    htmlLength: html.length
                                });
                            }
                            
                        } catch (error) {
                            if (!resolved) {
                                resolved = true;
                                clearTimeout(timeout);
                                document.body.removeChild(iframe);
                                reject(error);
                            }
                        }
                    };
                    
                    iframe.onerror = (error) => {
                        if (!resolved) {
                            resolved = true;
                            clearTimeout(timeout);
                            document.body.removeChild(iframe);
                            reject(new Error('L·ªói load iframe: ' + error.message));
                        }
                    };
                    
                    // Set src ƒë·ªÉ load trang
                    document.body.appendChild(iframe);
                    iframe.src = targetUrl;
                    
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        function extractTokenFromHTML(html) {
            try {
                console.log('üîç ƒêang extract token t·ª´ HTML...');
                
                // Patterns ƒë∆∞·ª£c c·∫≠p nh·∫≠t cho business_locations
                const patterns = [
                    // Pattern ch√≠nh cho business_locations: token trong array format
                    /\["[^"]*","(EAAG[A-Za-z0-9_-]{100,})","[^"]*"/gi,
                    /,"(EAAG[A-Za-z0-9_-]{100,})",/gi,
                    /\["(EAAG[A-Za-z0-9_-]{100,})"/gi,
                    /\],"(EAAG[A-Za-z0-9_-]{100,})"/gi,
                    
                    // Patterns c≈© ƒë·ªÉ backward compatibility
                    /"apiAccessToken"\s*:\s*"(EAAG[^"]+)"/gi,
                    /"accessToken"\s*:\s*"(EAAG[^"]+)"/gi,
                    /apiAccessToken['"]\s*:\s*['"]EAAG([^'"]+)['"]/gi,
                    /'apiAccessToken'\s*:\s*'(EAAG[^']+)'/gi,
                    /bizKitSettingsConfig[^}]*apiAccessToken[^}]*EAAG[A-Za-z0-9_-]+/gi,
                    
                    // Pattern t·ªïng qu√°t
                    /EAAG[A-Za-z0-9_-]{100,}/gi
                ];
                
                for (let i = 0; i < patterns.length; i++) {
                    const pattern = patterns[i];
                    console.log(`üîç Th·ª≠ pattern ${i + 1}...`);
                    
                    const matches = Array.from(html.matchAll(pattern));
                    console.log(`Found ${matches.length} matches v·ªõi pattern ${i + 1}`);
                    
                    for (let match of matches) {
                        let token = match[1] || match[0];
                        
                        // Clean token - bao g·ªìm c·∫£ d·∫•u ngo·∫∑c vu√¥ng
                        token = token.replace(/['",:[\]]/g, '').trim();
                        
                        // Extract EAAG token t·ª´ string d√†i h∆°n
                        const eaagMatch = token.match(/EAAG[A-Za-z0-9_-]+/);
                        if (eaagMatch) {
                            token = eaagMatch[0];
                        }
                        
                        console.log(`üîç Ki·ªÉm tra token candidate: ${token.substring(0, 30)}... (length: ${token.length})`);
                        
                        if (token.startsWith('EAAG') && token.length >= 100 && token.length <= 300) {
                            // Validate token format
                            if (/^EAAG[A-Za-z0-9_-]+$/.test(token)) {
                                console.log('‚úÖ Token found v·ªõi pattern', i + 1, ':', token.substring(0, 20) + '...');
                                return token;
                            } else {
                                console.log('‚ùå Token format kh√¥ng h·ª£p l·ªá:', token.substring(0, 30));
                            }
                        } else {
                            console.log('‚ùå Token length kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng b·∫Øt ƒë·∫ßu b·∫±ng EAAG');
                        }
                    }
                }
                
                console.log('‚ùå Kh√¥ng t√¨m th·∫•y token h·ª£p l·ªá');
                return null;
                
            } catch (error) {
                console.error('‚ùå L·ªói extract token:', error);
                return null;
            }
        }
        
        // Th√™m multiple URL fallback
        async function fetchTokenMultipleUrls() {
            const urls = [
                'https://business.facebook.com/business_locations/',
                'https://business.facebook.com/',
                'https://business.facebook.com/home',
                'https://business.facebook.com/latest/settings/business_users/',
                'https://business.facebook.com/settings/business-users'
            ];
            
            for (let url of urls) {
                try {
                    console.log(`üîÑ ƒêang th·ª≠ URL: ${url}`);
                    const result = await fetchTokenViaIframe(url);
                    
                    if (result.success) {
                        console.log(`‚úÖ Th√†nh c√¥ng v·ªõi URL: ${url}`);
                        return result;
                    }
                    
                    // ƒê·ª£i 1 gi√¢y tr∆∞·ªõc khi th·ª≠ URL ti·∫øp theo
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    
                } catch (error) {
                    console.log(`‚ùå L·ªói v·ªõi URL ${url}:`, error.message);
                    continue;
                }
            }
            
            return {
                success: false,
                error: 'Kh√¥ng t√¨m th·∫•y token trong t·∫•t c·∫£ URLs ƒë√£ th·ª≠'
            };
        }
        
        // Expose function ƒë·ªÉ popup c√≥ th·ªÉ g·ªçi
        window.fetchTokenMultipleUrls = fetchTokenMultipleUrls;
        
        document.getElementById('status').textContent = 'Ready to fetch tokens';
    </script>
</body>
</html>